<div class="row">
  <div class="col-sm-12 col-lg-12">
    <div class="iq-card">
      <div class="iq-card-body">
        <div class="row">
          <div class="col-md-12">
            <div class="iq-card">
              <div class="iq-card-header d-flex justify-content-between">
                <div class="iq-header-title">
                  <h4 class="card-title">Cumulative Report</h4>
                </div>
              </div>
              <div class="iq-card-body">
                <form id="form-wizard3" class="text-center">
                  <div class="form-card text-left">
                    <div class="row">
                      <div class="col-md-12">
                        <div class="table-responsive">
                          <div class="row justify-content-between">
                            <div class="col-md-12">
                              <button class="mr-1 mb-2" (click)="exportAs('csv')">export as csv</button>
                              <button class="mr-1 mb-2" (click)="exportAs('xlsx')">export as Ms-Excel</button>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-md-2">
                              <!-- <app-datepicker-range 
                              (dateSelection)="setFilter('date', $event)"></app-datepicker-range> -->
                              <div class="form-group">
                                <label for="exampleInputSite">Select Site</label>
                                <select class="form-control" id="exampleInputSite" name="site_id" (change)="changeSiteSelection($event)"
                                  [value]="selectedSiteId">
                                  <option [attr.value]="col._id" *ngFor="let col of sitesArr">{{col.name}}</option>
                                </select>
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputdateFrom">From Date</label>
                                <input type="date" class="form-control" id="exampleInputdateFrom" (change)="selectDateFrom($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputdateTo">To Date</label>
                                <input type="date" class="form-control" id="exampleInputdateTo" (change)="selectDateTo($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputtimeFrom">From Time</label>
                                <input type="time" class="form-control" id="exampleInputtimeFrom" (change)="selectTimeFrom($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputtimeTo">To Time</label>
                                <input type="time" class="form-control" id="exampleInputtimeTo" (change)="selectTimeTo($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group" style="margin-top: 35px;">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-primary" value="Submit" (click)="fetchCumulativeData(selectedSiteId)">Apply Search</button>
                              </div>
                            </div>
                          </div>
                          <div class="row" *ngIf="dataArr && dataArr.length > 0">
                            <div class="col-md-10">
                              <div class="form-group">
                                <label for="tagColumn">Select Tags/Columns</label>
                                <ng-multiselect-dropdown
                                  [placeholder]="'Select Tags/Columns'"
                                  [settings]="dropdownSettings"
                                  [data]="tagsArr"
                                  [(ngModel)]="selectedTags"
                                  (onSelect)="onChangeTag($event)"
                                  (onSelectAll)="onChangeAllTag($event)"
                                  (onDeSelect)="onChangeTag($event)"
                                  (onDeSelectAll)="onChangeAllTag($event)"
                                  name="selectedTags"
                                >
                                </ng-multiselect-dropdown>
                                <!-- <select multiple class="form-control" id="tagColumn" name="tag_id[]" (change)="changeTagSelection($event)">
                                  <option selected [attr.value]="col.id" *ngFor="let col of tagsArr">{{col.name}}</option>
                                </select> -->
                              </div>
                            </div>
                          </div>
                          <div class="row justify-content-between">
                            <div class="col-md-12">
                              <table id="mytable" class="table table-striped table-bordered mt-4 cumulative-reports" role="grid"
                                aria-describedby="user-list-page-info">
                                <thead *ngIf="dataArr && dataArr.length > 0">
                                  <tr class="header-outer">
                                    <th colspan="100" class="text-left">STATION NAME:
                                      {{selectedSiteData?.name}}</th>
                                  </tr>
                                  <tr class="header-outer">
                                    <th colspan="100" class="text-left">DETAILED REPORT FOR THE PERIOD OF: {{dateFromVal}} To {{dateToVal}}
                                      <span *ngIf="timeFromVal !== ''">{{timeFromVal}} To {{timeToVal}}</span>
                                    </th>
                                  </tr>
                                  <tr style="display: none;">
                                    <th width="10%">DATE-TIME</th>
                                    <th class="text-center"
                                      *ngFor='let pmpTh of dataArr[0].pumpData; let pumpInd = index;'
                                      [attr.colspan]="getPumpDataLength(dataArr[0].pumpData[pumpInd])">
                                      PUMP {{ pumpInd + 1}}
                                    </th>

                                    <th class="text-center"
                                      *ngFor='let meterTh of dataArr[0].meterData; let meterInd = index;'
                                      [attr.colspan]="getMeterDataLength(dataArr[0].meterData[meterInd])"
                                      >
                                      DATA METER {{ meterInd + 1}}
                                    </th>
                                    <th width="5%" [attr.class]="convertToSlug('Flow Meter')">FLOW RATE</th>
                                    <th width="5%" [attr.class]="convertToSlug('Level Sensor')">LEVEL RATE</th>
                                  </tr>
                                  <tr class="header">
                                    <th width="10%">DATE-TIME</th>
                                    <ng-container *ngFor='let innerData of dataArr[0].pumpData; let pumpInd = index;'>
                                      <ng-container *ngFor='let data of innerData'>
                                          <th *ngFor='let subheader of data | keyvalue'
                                          [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheader.key)">
                                            PUMP {{ pumpInd + 1}} <br/>({{subheader.key | uppercase}})
                                          </th>
                                        </ng-container>
                                    </ng-container>
                                    <ng-container *ngFor='let mtkey of dataArr[0].meterData; let meterInd = index;'>
                                      <th *ngFor='let subheaderMt of mtkey | keyvalue'
                                      [attr.class]="convertToSlug('Meter '+(meterInd+1)+' - '+subheaderMt.key)">
                                        DATA METER <br/>({{subheaderMt.key | uppercase}})
                                      </th>
                                    </ng-container>
                                    <th width="5%" [attr.class]="convertToSlug('Flow Meter')">FLOW RATE</th>
                                    <th width="5%" [attr.class]="convertToSlug('Level Sensor')">LEVEL RATE</th>
                                  </tr>
                                </thead>
                                <tbody *ngIf="dataArr && dataArr.length > 0">
                                  <tr
                                    *ngFor="let dataEle of dataArr; let dataEleIndex = index">
                                    <td>{{ dataEle.date + ' '+ dataEle.time }}</td>
                                    <ng-container *ngFor='let pEle of dataEle.pumpData; let pumpInd = index;'>
                                     <ng-container *ngFor='let data of pEle; let pumpIndInner = index;'>
                                         <th *ngFor='let subheaderPmp of data | keyvalue; let pumpKeyValueIndex = index;'
                                         [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheaderPmp.key)"
                                          >
                                            <span *ngIf="pumpIndInner == 0 && !subheaderPmp.value">OFF</span>
                                            <span *ngIf="pumpIndInner == 1 && !subheaderPmp.value">MANUAL</span>
                                            <span *ngIf="pumpIndInner == 2 && !subheaderPmp.value">CLOSE</span>
                                            <span *ngIf="pumpIndInner == 3 && !subheaderPmp.value">NORMAL</span>
                                            <span *ngIf="subheaderPmp.value">{{subheaderPmp.value}}</span>
                                          </th>
                                        </ng-container>
                                      
                                    </ng-container>
                                    <ng-container *ngIf='dataEle.pumpData.length == 0 && dataArr[dataEleIndex-1] && dataArr[dataEleIndex-1].pumpData.length == 0'>
                                      <ng-container *ngFor='let pmpTh of dataArr[0].pumpData; let pumpInd = index;'>
                                        <ng-container *ngFor='let data of pmpTh; let pumpIndInner = index;'>
                                          <th *ngFor='let subheaderPmp of data | keyvalue; let 
                                          pumpKeyValueIndex = index;'
                                          [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheaderPmp.key)"
                                          >
                                           -
                                          </th>
                                        </ng-container>
                                      </ng-container>
                                    </ng-container>
                                    <ng-container *ngIf='dataEle.pumpData.length == 0 && dataArr[dataEleIndex-1] && dataArr[dataEleIndex-1].pumpData.length > 0'>
                                      <ng-container *ngFor='let pEle of dataArr[dataEleIndex-1].pumpData; let pumpInd = index;'>
                                        <ng-container *ngFor='let data of pEle; let pumpIndInner = index;'>
                                            <th *ngFor='let subheaderPmp of data | keyvalue; let 
                                            pumpKeyValueIndex = index;'
                                            [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheaderPmp.key)"
                                            >
                                              <span *ngIf="pumpIndInner == 0 && !subheaderPmp.value">OFF</span>
                                              <span *ngIf="pumpIndInner == 1 && !subheaderPmp.value">MANUAL</span>
                                              <span *ngIf="pumpIndInner == 2 && !subheaderPmp.value">CLOSE</span>
                                              <span *ngIf="pumpIndInner == 3 && !subheaderPmp.value">NORMAL</span>
                                              <span *ngIf="subheaderPmp.value">{{subheaderPmp.value}}</span>
                                            </th>
                                          </ng-container>
                                      </ng-container>
                                    </ng-container>
                                    
                                    <ng-container *ngFor='let mEle of dataEle.meterData;let mtInd = index;'>
                                      <th *ngFor='let subheaderMt of mEle | keyvalue'
                                      [attr.class]="convertToSlug('Meter '+(mtInd+1)+' - '+subheaderMt.key)"
                                      >
                                        <ng-container *ngIf='subheaderMt.value == "-" && dataArr[dataEleIndex-1] && dataArr[dataEleIndex-1].meterData.length > 0'>
                                          <span *ngFor='let subheaderMt of dataArr[dataEleIndex-1].meterData[mtInd] | keyvalue'>
                                              {{subheaderMt.value}}
                                          </span>
                                        </ng-container>
                                        <span *ngIf='subheaderMt.value != "-"'>{{subheaderMt.value}}</span>
                                      </th>
                                    </ng-container>
                                    <ng-container [attr.class]="convertToSlug('Flow Meter')" *ngFor='let fEle of dataEle.flowData'>
                                      <th *ngFor='let subheaderFlow of fEle | keyvalue'>
                                        {{subheaderFlow.value}}
                                      </th>
                                    </ng-container>
                                    <ng-container  [attr.class]="convertToSlug('Level Sensor')" *ngFor='let lEle of dataEle.levelData'>
                                      <th *ngFor='let subheaderLevel of lEle | keyvalue'>
                                        {{subheaderLevel.value}}
                                      </th>
                                    </ng-container>
                                    <td [attr.class]="convertToSlug('Flow Meter')" *ngIf="dataEle.flowData.length == 0">
                                      - </td>
                                    <td [attr.class]="convertToSlug('Level Sensor')" *ngIf="dataEle.levelData.length == 0">
                                      - </td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                          <!-- <div class="row justify-content-between mt-3 mb-3">
                            <div class="col-md-12">
                              <ngb-pagination [collectionSize]="dataArr.length" [(page)]="page" [maxSize]="5"
                                [rotate]="true" [ellipses]="false" [boundaryLinks]="true"></ngb-pagination>
                            </div>
                          </div> -->
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>