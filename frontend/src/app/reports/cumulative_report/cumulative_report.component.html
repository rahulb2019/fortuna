<div class="row">
  <div class="col-sm-12 col-lg-12">
    <div class="iq-card">
      <div class="iq-card-body">
        <div class="row">
          <div class="col-md-12">
            <div class="iq-card">
              <div class="iq-card-header d-flex justify-content-between">
                <div class="iq-header-title">
                  <h4 class="card-title">Cumulative Report</h4>
                </div>
              </div>
              <div class="row iq-card-body p-0 d-flex">
                <div class="col-md-6">
                  <div id="apex-column-flow"></div>
                  <div *ngIf="dataArr && dataArr.length > 0" style="text-align: center;text-decoration: underline;"><h3>Flow Rate</h3></div>
                </div>
                <div class="col-md-6">
                  <div id="apex-column-level"></div>
                  <div *ngIf="dataArr && dataArr.length > 0" style="text-align: center;text-decoration: underline;"><h3>Level Sensor</h3></div>
                </div>
              </div>
              
              <div class="iq-card-body p-0">
                <div id="apex-column-meter"></div>
                <div *ngIf="dataArr && dataArr.length > 0" style="text-align: center;text-decoration: underline;"><h3>Data Meters</h3></div>
              </div>
              
              <div class="row iq-card-body p-0 d-flex">
                <div class="col-md-6">
                  <div id="apex-column-chlorine"></div>
                  <div *ngIf="arrChlorineFinal && arrChlorineFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>Chlorine</h3></div>
                </div>
                <div class="col-md-6">
                  <div id="apex-column-turbidity"></div>
                  <div *ngIf="arrTurbidityFinal && arrTurbidityFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>Turbidity</h3></div>
                </div>
              </div>
              
              <div class="row iq-card-body p-0 d-flex">
                <div class="col-md-6">
                  <div id="apex-column-tds"></div>
                  <div *ngIf="arrTDSFinal && arrTDSFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>TDS</h3></div>
                </div>
                <div class="col-md-6">
                  <div id="apex-column-ph"></div>
                  <div *ngIf="arrPHFinal && arrPHFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>PH</h3></div>
                </div>
              </div>
              
              <div class="row iq-card-body p-0 d-flex">
                <div class="col-md-6">
                  <div id="apex-column-press-transmeter"></div>
                  <div *ngIf="arrPTFinal && arrPTFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>Pressure Transmeter</h3></div>
                </div>
                <div class="col-md-6">
                  <div id="apex-column-depth"></div>
                  <div *ngIf="arrDepthFinal && arrDepthFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>Depth</h3></div>
                </div>
              </div>
              
              <div class="row iq-card-body p-0 d-flex">
                <div class="col-md-6">
                  <div id="apex-column-vibration"></div>
                  <div *ngIf="arrVibrationFinal && arrVibrationFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>Vibration</h3></div>
                </div>
                <div class="col-md-6">
                  <div id="apex-column-temp"></div>
                  <div *ngIf="arrTemperatureFinal && arrTemperatureFinal?.data?.length > 0" style="text-align: center;text-decoration: underline;"><h3>Temperature</h3></div>
                </div>
              </div>
              <div class="iq-card-body mt-3">
                <form id="form-wizard3" class="text-center">
                  <div class="form-card text-left">
                    <div class="row">
                      <div class="col-md-12">
                        <div class="table-responsive">
                          <div class="row justify-content-between">
                            <div class="col-md-12">
                              <button class="mr-1 mb-2" (click)="exportAs('csv')">export as csv</button>
                              <button class="mr-1 mb-2" (click)="exportAs('xlsx')">export as Ms-Excel</button>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputSite">Select Site</label>
                                <select class="form-control" id="exampleInputSite" name="site_id" (change)="changeSiteSelection($event)"
                                  [value]="selectedSiteId">
                                  <option [attr.value]="col._id" *ngFor="let col of sitesArr">{{col.name}}</option>
                                </select>
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputdateFrom">From Date</label>
                                <input type="date" class="form-control" id="exampleInputdateFrom" (change)="selectDateFrom($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputdateTo">To Date</label>
                                <input type="date" class="form-control" id="exampleInputdateTo" (change)="selectDateTo($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputtimeFrom">From Time</label>
                                <input type="time" class="form-control" id="exampleInputtimeFrom" (change)="selectTimeFrom($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputtimeTo">To Time</label>
                                <input type="time" class="form-control" id="exampleInputtimeTo" (change)="selectTimeTo($event)">
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group">
                                <label for="exampleInputInterval">Select Interval</label>
                                <select class="form-control" id="exampleInputInterval" name="site_id" (change)="changeIntervalSelection($event)">
                                  <option value="">-Select-</option>
                                  <option value="15">15 minutes</option>
                                  <option value="30">30 minutes</option>
                                  <option value="60">1 hour</option>
                                  <option value="120">2 hours</option>
                                </select>
                              </div>
                            </div>
                            <div class="col-md-2">
                              <div class="form-group" style="margin-top: 35px;">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-primary" value="Submit" (click)="fetchCumulativeData(selectedSiteId)">Apply Search</button>
                              </div>
                            </div>
                          </div>
                          <div class="row" *ngIf="dataArr && dataArr.length > 0">
                            <div class="col-md-10">
                              <div class="form-group">
                                <label for="tagColumn">Select Tags/Columns</label>
                                <ng-multiselect-dropdown
                                  [placeholder]="'Select Tags/Columns'"
                                  [settings]="dropdownSettings"
                                  [data]="tagsArr"
                                  [(ngModel)]="selectedTags"
                                  (onSelect)="onChangeTag($event)"
                                  (onSelectAll)="onChangeAllTag($event)"
                                  (onDeSelect)="onChangeTag($event)"
                                  (onDeSelectAll)="onChangeAllTag($event)"
                                  name="selectedTags"
                                >
                                </ng-multiselect-dropdown>
                              </div>
                            </div>
                          </div>
                          <div class="row justify-content-between">
                            <div class="col-md-12">
                              <table id="mytable" class="table table-striped table-bordered mt-4 cumulative-reports" role="grid"
                                aria-describedby="user-list-page-info">
                                <thead *ngIf="dataArr && dataArr.length > 0">
                                  <tr class="header-outer">
                                    <th colspan="100" class="text-left">STATION NAME:
                                      {{selectedSiteData?.name}}</th>
                                  </tr>
                                  <tr class="header-outer">
                                    <th colspan="100" class="text-left">DETAILED REPORT FOR THE PERIOD OF: {{dateFromVal}} To {{dateToVal}}
                                      <span *ngIf="timeFromVal !== ''">{{timeFromVal}} To {{timeToVal}}</span>
                                    </th>
                                  </tr>
                                  <tr style="display: none;">
                                    <th width="10%">DATE-TIME</th>
                                    <th class="text-center"
                                      *ngFor='let pmpTh of dataArr[0].pumpData; let pumpInd = index;'
                                      [attr.colspan]="getPumpDataLength(dataArr[0].pumpData[pumpInd])">
                                      PUMP {{ pumpInd + 1}}
                                    </th>

                                    <th class="text-center"
                                      *ngFor='let meterTh of dataArr[0].meterData; let meterInd = index;'
                                      [attr.colspan]="getMeterDataLength(dataArr[0].meterData[meterInd])"
                                      >
                                      DATA METER {{ meterInd + 1}}
                                    </th>
                                    <th width="5%" [attr.class]="convertToSlug('Flow Meter')">FLOW RATE</th>
                                    <th width="5%" [attr.class]="convertToSlug('Level Sensor')">LEVEL RATE</th>
                                  </tr>
                                  <tr class="header">
                                    <th width="10%">DATE-TIME</th>
                                    <ng-container *ngFor='let innerData of dataArr[0].pumpData; let pumpInd = index;'>
                                      <ng-container *ngFor='let data of innerData'>
                                          <th *ngFor='let subheader of data | keyvalue'
                                          [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheader.key)">
                                            PUMP {{ pumpInd + 1}} <br/>({{subheader.key | uppercase}})
                                          </th>
                                        </ng-container>
                                    </ng-container>
                                    <ng-container *ngFor='let mtkey of dataArr[0].meterData; let meterInd = index;'>
                                      <th *ngFor='let subheaderMt of mtkey | keyvalue'
                                      [attr.class]="convertToSlug('Meter '+(meterInd+1)+' - '+subheaderMt.key)">
                                        DATA METER <br/>({{subheaderMt.key | uppercase}})
                                      </th>
                                    </ng-container>
                                    <th width="5%" [attr.class]="convertToSlug('Flow Meter')">FLOW RATE</th>
                                    <th width="5%" [attr.class]="convertToSlug('Level Sensor')">LEVEL RATE</th>
                                  </tr>
                                </thead>
                                <tbody *ngIf="dataArr && dataArr.length > 0">
                                  <tr
                                    *ngFor="let dataEle of dataArr; let dataEleIndex = index">
                                    <td>{{ dataEle.date + ' '+ dataEle.time }}</td>
                                    <ng-container *ngFor='let pEle of dataEle.pumpData; let pumpInd = index;'>
                                     <ng-container *ngFor='let data of pEle; let pumpIndInner = index;'>
                                         <th *ngFor='let subheaderPmp of data | keyvalue; let pumpKeyValueIndex = index;'
                                         [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheaderPmp.key)"
                                          >
                                            <span *ngIf="pumpIndInner == 0 && !subheaderPmp.value">OFF</span>
                                            <span *ngIf="pumpIndInner == 1 && !subheaderPmp.value">MANUAL</span>
                                            <span *ngIf="pumpIndInner == 2 && !subheaderPmp.value">CLOSE</span>
                                            <span *ngIf="pumpIndInner == 3 && !subheaderPmp.value">NORMAL</span>
                                            <span *ngIf="subheaderPmp.value">{{subheaderPmp.value}}</span>
                                          </th>
                                        </ng-container>
                                      
                                    </ng-container>
                                    <ng-container *ngIf='dataEle.pumpData.length == 0 && dataArr[dataEleIndex-1] && dataArr[dataEleIndex-1].pumpData.length == 0'>
                                      <ng-container *ngFor='let pmpTh of dataArr[0].pumpData; let pumpInd = index;'>
                                        <ng-container *ngFor='let data of pmpTh; let pumpIndInner = index;'>
                                          <th *ngFor='let subheaderPmp of data | keyvalue; let 
                                          pumpKeyValueIndex = index;'
                                          [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheaderPmp.key)"
                                          >
                                           -
                                          </th>
                                        </ng-container>
                                      </ng-container>
                                    </ng-container>
                                    <ng-container *ngIf='dataEle.pumpData.length == 0 && dataArr[dataEleIndex-1] && dataArr[dataEleIndex-1].pumpData.length > 0'>
                                      <ng-container *ngFor='let pEle of dataArr[dataEleIndex-1].pumpData; let pumpInd = index;'>
                                        <ng-container *ngFor='let data of pEle; let pumpIndInner = index;'>
                                            <th *ngFor='let subheaderPmp of data | keyvalue; let 
                                            pumpKeyValueIndex = index;'
                                            [attr.class]="convertToSlug('Pump '+(pumpInd+1)+' - '+subheaderPmp.key)"
                                            >
                                              <span *ngIf="pumpIndInner == 0 && !subheaderPmp.value">OFF</span>
                                              <span *ngIf="pumpIndInner == 1 && !subheaderPmp.value">MANUAL</span>
                                              <span *ngIf="pumpIndInner == 2 && !subheaderPmp.value">CLOSE</span>
                                              <span *ngIf="pumpIndInner == 3 && !subheaderPmp.value">NORMAL</span>
                                              <span *ngIf="subheaderPmp.value">{{subheaderPmp.value}}</span>
                                            </th>
                                          </ng-container>
                                      </ng-container>
                                    </ng-container>
                                    
                                    <ng-container *ngFor='let mEle of dataEle.meterData;let mtInd = index;'>
                                      <th *ngFor='let subheaderMt of mEle | keyvalue'
                                      [attr.class]="convertToSlug('Meter '+(mtInd+1)+' - '+subheaderMt.key)"
                                      >
                                        <ng-container *ngIf='subheaderMt.value == "-" && dataArr[dataEleIndex-1] && dataArr[dataEleIndex-1].meterData.length > 0'>
                                          <span *ngFor='let subheaderMt of dataArr[dataEleIndex-1].meterData[mtInd] | keyvalue'>
                                              {{subheaderMt.value}}
                                          </span>
                                        </ng-container>
                                        <span *ngIf='subheaderMt.value != "-"'>{{subheaderMt.value}}</span>
                                      </th>
                                    </ng-container>
                                    <ng-container [attr.class]="convertToSlug('Flow Meter')" *ngFor='let fEle of dataEle.flowData'>
                                      <th *ngFor='let subheaderFlow of fEle | keyvalue'>
                                        {{subheaderFlow.value}}
                                      </th>
                                    </ng-container>
                                    <ng-container  [attr.class]="convertToSlug('Level Sensor')" *ngFor='let lEle of dataEle.levelData'>
                                      <th *ngFor='let subheaderLevel of lEle | keyvalue'>
                                        {{subheaderLevel.value}}
                                      </th>
                                    </ng-container>
                                    <td [attr.class]="convertToSlug('Flow Meter')" *ngIf="dataEle.flowData.length == 0">
                                      - </td>
                                    <td [attr.class]="convertToSlug('Level Sensor')" *ngIf="dataEle.levelData.length == 0">
                                      - </td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>